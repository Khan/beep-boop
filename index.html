<!DOCTYPE>
<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
	<script src="jquery.tablesorter.min.js" type="text/javascript"></script>
	<link rel="stylesheet" href="style.css" type="text/css" media="all" />
</head>
<script>
jQuery( document ).ready(function() {
	var days = 7;
	var chart;
	var remaining = 0;

	var getStats = function( index, row ) {
		++remaining;
		jQuery( "#loading" ).text( "Getting exercise stats... (" + remaining + ")" );
		jQuery.getJSON( 'http://www.khanacademy.org/exercisestats/exerciseovertime?chart=area_spline&past_days=' + days + '&rsecs=30&buckets=500&ix=' + index + '&callback=?', function( data ) {
			--remaining;
			jQuery( "#loading" ).text( "Getting exercise stats... (" + remaining + ")" );
			var totalProblemsDone = 0;
			jQuery.each( data.series[0].data, function() {
				totalProblemsDone += this[1];
			});
			var issueCount = row.find( "td" ).last().text();
			jQuery( "<td>" ).text( totalProblemsDone ).appendTo( row );
			jQuery( "<td>" ).text( ( issueCount / totalProblemsDone * 1000 ).toFixed( 2 ) ).appendTo( row );
			jQuery( "table" ).trigger( "update" );
			jQuery( "table" ).trigger( "sorton", [[[ 3, 1 ]]] );
			if ( remaining === 0 ) {
				jQuery( "#loading" ).fadeOut( 200 );
			}
		});
	};

	var issues = {};

	var getIssues = function( page ) {
		jQuery( "#loading" ).text( "Loading issues from GitHub... (" + page * 100 + ")" );
		jQuery.getJSON( 'https://api.github.com/repos/Khan/khan-exercises/issues?page=' + page + '&per_page=100&callback=?', function( data ) {
			jQuery( "#githublimit" ).text( data.meta[ "X-RateLimit-Remaining" ] );
			jQuery.each( data.data, function() {
				var created = new Date( this.created_at.replace( /-/g, "/" ).replace( /[TZ]/g, " " ) );
				var timediff = ( ( ( new Date() ).getTime() - created.getTime() + created.getTimezoneOffset() * 60000 ) / 1000 );
				if ( this.user.login === "KhanBugz" && timediff < 86400 * days ) {
					var exercise = this;
					var exerciseName = this.title.split(" - ")[0];

					if ( exerciseName in issues ) {
						issues[ exerciseName ].push( this );
					} else {
						issues[ exerciseName ] = [ this ];
					}
				}
			});

			if ( data.meta.Link[0][1].rel === "next" ) {
				getIssues( page + 1 );
			} else {
				jQuery.getJSON( "http://www.khanacademy.org/api/v1/exercises?callback=?", function( data ) {
					var sortedExercises = data.sort( function(a, b) {
						var compA = a.display_name.toUpperCase();
						var compB = b.display_name.toUpperCase();
						return (compA < compB) ? -1 : (compA > compB) ? 1 : 0;
					});

					jQuery.each( sortedExercises, function( n ) {
						var row = jQuery("<tr>").append( jQuery("<td>").text( this.display_name ).appendTo( jQuery("<tr>") )).appendTo( jQuery("#exercises>tbody") );
						var issueCount = 0;
						if ( issues[ this.display_name ] !== undefined ) {
							issueCount = issues[ this.display_name ].length;
						}
						jQuery( "<td>" ).text( issueCount ).appendTo( row );
						getStats( n, row );
					});
				});
			}
		});
	};

	jQuery( "table" ).tablesorter();
	getIssues( 1 );


});
</script>
<body>
<div id="messages">
	<div id="loading">
		Loading issues from GitHub...
	</div>
</div>

<table id="exercises" class="tablesorter">
	<thead>
		<tr>
			<th>Exercise</th>
			<th>Issues opened in last 7 days</th>
			<th>Problems done last 7 days</th>
			<th>Issues / 1k problems</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</body>
</html>
